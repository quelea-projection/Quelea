name: Build CI release

on:
  push:
    branches:
      - 'master'

jobs:
  release:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'adopt'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          version: '8.13'

      - name: Windows innosetup
        if: ${{ matrix.os == 'windows-latest' }}
        run: |
          Invoke-WebRequest -Uri  http://files.jrsoftware.org/is/6/innosetup-6.2.2.exe -OutFile is.exe
          .\is.exe /VERYSILENT /SUPPRESSMSGBOXES

      - name: Build
        run: |
          cd Quelea
          gradle -Dnightly=true -Dversionsuffix=CI-UNSTABLE clean labelcheck downloadJres jar copyToDist

      - name: Create standalones
        if: ${{ matrix.os != 'windows-latest' }}
        run: |
          cd Quelea
          gradle tar runPackr izpack releaseSummary

      - name: Create standalone
        if: ${{ matrix.os == 'windows-latest' }}
        run: |
          cd Quelea
          gradle -Dnightly=true -Dversionsuffix=CI-UNSTABLE innosetup releaseSummary

      - name: Upload binaries to release
        uses: softprops/action-gh-release@v2
        with:
          files: Quelea/dist/standalone/*
          tag_name: CI-RELEASE
          prerelease: true
          make_latest: false
          body: "**This is a CI Build, built from the latest copy of the source code automatically. 
                It's not an official release and we don't recommend using this in production.**<br/>
                Quelea is also distributed as a Linux snap package. To install it, make 
                sure snap is installed then run:
                <pre>sudo snap install --edge quelea</pre>"
